name: Build Preview

on:
  pull_request:
    types:
      - labeled
      - synchronize

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  build-preview:
    if: >
      github.repository == 'mattrossman/forecaswatch2' &&
      (
        (github.event.action == 'labeled' && github.event.label.name == 'build-preview') ||
        (github.event.action == 'synchronize' && contains(github.event.pull_request.labels.*.name, 'build-preview'))
      ) &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    concurrency:
      group: build-preview-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up mise toolchain
        uses: jdx/mise-action@v3
        with:
          install: true
          cache: true

      - name: Build .pbw
        run: mise build

      - name: Verify artifact exists
        run: test -f build/forecaswatch2.pbw

      - name: Upload .pbw artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: forecaswatch2-pbw-pr-${{ github.event.pull_request.number }}.zip
          path: build/forecaswatch2.pbw
          if-no-files-found: error
          retention-days: 14

      - name: Upsert PR comment with artifact link
        uses: actions/github-script@v7
        env:
          ARTIFACT_URL: ${{ steps.upload.outputs.artifact-url }}
        with:
          script: |
            const marker = '<!-- build-preview-artifact -->';
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            if (!process.env.ARTIFACT_URL) {
              throw new Error('upload-artifact did not return artifact-url');
            }
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${owner}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const prNumber = context.payload.pull_request.number;
            const artifactName = `forecaswatch2-pbw-pr-${prNumber}.zip`;

            const body = [
              marker,
              'âœ… Preview build available.',
              '',
              `Download [${artifactName}](${process.env.ARTIFACT_URL})`,
              '',
              'Artifacts are attached to the workflow run/job and require GitHub access to this repository.',
              `Run: [#${process.env.GITHUB_RUN_NUMBER}](${runUrl})`,
            ].join('\n');

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find((comment) =>
              comment.user?.type === 'Bot' && comment.body?.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body,
              });
            }
